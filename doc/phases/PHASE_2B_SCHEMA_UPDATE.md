# Phase 2B: Schema Update

## AI Implementation Instructions

- **build_runner**: Running in watch mode automatically. Do NOT run manually.
- If `.freezed.dart` or `.g.dart` files don't generate after ~30 seconds, assume syntax error in the source `.dart` file.
- **Validation**: Run `flutter analyze` after each phase/subphase. Fix ALL errors and warnings before proceeding.
- **Tests**: IGNORE tests during implementation. Do not run or update test files - do not fix errors for compilation of tests.
- **Forms**: Prefer `flutter_form_builder` fields and extensions where applicable.
- **Reuse**: Check existing patterns in codebase before creating new ones.

---

## Goal

Update the `sectionsConfigConverter` to use the proper `Section` type now that it exists.

**Note**: Database schema (Supabase + PowerSync + Drift) has already been updated. This phase only updates the converter.

---

## Prerequisites

- Phase 2A complete (Section model exists)
- Supabase schema already updated (columns added/removed)
- `schema.dart` already updated
- `screen_tables.drift.dart` already updated

---

## Task 1: Update sectionsConfigConverter

**File**: `lib/data/drift/converters/json_converters.dart`

Update the temporary `sectionsConfigConverter` to use the actual `Section` type:

**Find this code:**
```dart
/// Type converter for `List<Section>` stored as JSON text.
/// Note: Section type will be created in Phase 2A.
/// For now, stores raw JSON - will be updated when Section model exists.
final JsonTypeConverter2<List<Map<String, dynamic>>, String, Object?>
    sectionsConfigConverter = TypeConverter.json2(
  fromJson: _parseJsonListWithDoubleEncodingFallback,
  toJson: (List<Map<String, dynamic>> sections) => sections,
);
```

**Replace with:**
```dart
import 'package:taskly_bloc/domain/models/screens/section.dart';

/// Type converter for `List<Section>` stored as JSON text.
final JsonTypeConverter2<List<Section>, String, Object?>
    sectionsConfigConverter = TypeConverter.json2(
  fromJson: (json) {
    final list = _parseJsonListWithDoubleEncodingFallback(json);
    return list.map((item) => Section.fromJson(item)).toList();
  },
  toJson: (List<Section> sections) =>
      sections.map((section) => section.toJson()).toList(),
);
```

**Note**: Add the import for `section.dart` at the top of the file.

---

## Task 2: Verify Drift Code Generation

After updating the converter, the Drift-generated code should now properly type-check.

Run:
```bash
flutter analyze
```

If there are errors related to the converter types, verify that:
1. The `Section` class has proper `fromJson`/`toJson` methods (generated by freezed)
2. The import path is correct

---

## Validation Checklist

- [ ] `flutter analyze` returns 0 errors, 0 warnings (ignore test file errors)
- [ ] `sectionsConfigConverter` uses `List<Section>` type
- [ ] No type mismatch errors in `screen_tables.drift.dart`

---

## Files Modified

| File | Change |
|------|--------|
| `lib/data/drift/converters/json_converters.dart` | Update sectionsConfigConverter to use Section type |

---

## Next Phase

Proceed to **Phase 2C: Screen Definition Update** after validation passes.
